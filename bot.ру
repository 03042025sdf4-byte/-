import json
import re
from datetime import date
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes
import os

TOKEN = os.getenv("BOT_TOKEN")  # üîí —Ç–æ–∫–µ–Ω –±–µ—Ä—ë–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã
DATA_FILE = "data.json"

def load_data():
    try:
        with open(DATA_FILE, "r") as f:
            data = json.load(f)
            return {
                "total": data.get("total", 0),
                "expenses_today": data.get("expenses_today", 0),
                "date": data.get("date", str(date.today()))
            }
    except FileNotFoundError:
        return {"total": 0, "expenses_today": 0, "date": str(date.today())}

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f)

data = load_data()

# –°–±—Ä–æ—Å —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å
if data["date"] != str(date.today()):
    data["expenses_today"] = 0
    data["date"] = str(date.today())
    save_data(data)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global data
    text = update.message.text.strip()
    lines = text.split("\n")

    for line in lines:
        line = line.strip()
        if not line:
            continue

        if line.startswith("+"):
            # –ü—Ä–∏—Ö–æ–¥ –¥–µ–Ω–µ–≥
            try:
                num = int(line)
            except ValueError:
                continue
            data["total"] += num
        else:
            # –†–∞—Å—Ö–æ–¥ –¥–µ–Ω–µ–≥ (—á–∏—Å–ª–∞ –±–µ–∑ –∑–Ω–∞–∫–∞)
            try:
                num = int(line)
            except ValueError:
                continue
            data["total"] -= num
            data["expenses_today"] += num

    save_data(data)

    reply = (f"üìâ –†–∞—Å—Ö–æ–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {data['expenses_today']}\n"
             f"üí∞ –¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫: {data['total']}")
    await update.message.reply_text(reply)

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling()
