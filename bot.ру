import json
import re
from datetime import date
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, filters, ContextTypes
import os

TOKEN = os.getenv("BOT_TOKEN")  # ğŸ”’ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ ÑÑ€ĞµĞ´Ñ‹
DATA_FILE = "data.json"

def load_data():
    try:
        with open(DATA_FILE, "r") as f:
            data = json.load(f)
            # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ ĞºĞ»ÑÑ‡ĞµĞ¹, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¸Ñ…
            return {
                "total": data.get("total", 0),
                "expenses_today": data.get("expenses_today", 0),
                "date": data.get("date", str(date.today()))
            }
    except FileNotFoundError:
        return {"total": 0, "expenses_today": 0, "date": str(date.today())}

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f)

data = load_data()

# Ğ¡Ğ±Ñ€Ğ¾Ñ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ¾Ğ² Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ
if data["date"] != str(date.today()):
    data["expenses_today"] = 0
    data["date"] = str(date.today())
    save_data(data)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global data
    text = update.message.text.strip()
    lines = text.split("\n")

    added_numbers = []
    for line in lines:
        line = line.strip()
        if not line:
            continue

        if line.startswith("+"):
            # ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ´
            try:
                num = int(line)
            except ValueError:
                continue
            data["total"] += num
            added_numbers.append(num)
        else:
            # Ğ Ğ°ÑÑ…Ğ¾Ğ´ (Ñ‡Ğ¸ÑĞ»Ğ° Ğ±ĞµĞ· Ğ·Ğ½Ğ°ĞºĞ° Ğ¸Ğ»Ğ¸ Ñ Ğ¼Ğ¸Ğ½ÑƒÑĞ¾Ğ¼)
            try:
                num = int(line)
            except ValueError:
                continue
            data["total"] -= abs(num)  # Ğ²Ñ‹Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼
            data["expenses_today"] += abs(num)
            added_numbers.append(-abs(num))

    if added_numbers:
        save_data(data)
        added_str = ", ".join([f"{'+' if n > 0 else ''}{n}" for n in added_numbers])
        reply = (f"âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: {added_str}\n"
                 f"ğŸ’° Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº: {data['total']}\n"
                 f"ğŸ“‰ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ: {data['expenses_today']}")
        await update.message.reply_text(reply)

app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

if __name__ == "__main__":
    print("Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½...")
    app.run_polling()
